providers = ["python"]

[variables]
PYTHONUNBUFFERED = "1"

[phases.setup]
# Runtime dependencies for OpenCV
nixPkgs = ["python39", "libGL", "glib", "glibc", "libGLU", "pkg-config", "ffmpeg"]
# Add library paths so OpenCV can find libGL at runtime
nixLibs = ["libGL", "glib", "libGLU"]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate && pip install --no-cache-dir --upgrade pip",
  ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
  # Clean up pip cache and unnecessary files
  "rm -rf /opt/venv/lib/python3.9/site-packages/*/tests",
  "rm -rf /opt/venv/lib/python3.9/site-packages/*/test",
  "find /opt/venv -type d -name '__pycache__' -exec rm -r {} + 2>/dev/null || true",
  "find /opt/venv -type f -name '*.pyc' -delete",
  "find /opt/venv -type f -name '*.pyo' -delete"
]

[phases.build]
cmds = [
  # Make start script executable
  "chmod +x start.sh",
  # Create /usr/lib if it doesn't exist
  "mkdir -p /usr/lib",
  # Copy libGL and dependencies to /usr/lib (more reliable than symlinks)
  "echo 'Copying libGL and dependencies...'",
  "GL_LIB=$(find /nix/store -name 'libGL.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$GL_LIB\" ]; then cp \"$GL_LIB\" /usr/lib/libGL.so.1 && echo \"Copied libGL.so.1\"; fi",
  "GLIB_LIB=$(find /nix/store -name 'libglib-2.0.so.0' 2>/dev/null | head -n 1)",
  "if [ -n \"$GLIB_LIB\" ]; then cp \"$GLIB_LIB\" /usr/lib/libglib-2.0.so.0 && echo \"Copied libglib-2.0.so.0\"; fi",
  "GLU_LIB=$(find /nix/store -name 'libGLU.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$GLU_LIB\" ]; then cp \"$GLU_LIB\" /usr/lib/libGLU.so.1 && echo \"Copied libGLU.so.1\"; fi",
  # Also copy any .so files from the same directories
  "for lib in libGL.so libglib libGLU.so; do lib_dir=$(find /nix/store -name \"${lib}*\" 2>/dev/null | head -1 | xargs dirname 2>/dev/null); if [ -n \"$lib_dir\" ]; then cp $lib_dir/*.so* /usr/lib/ 2>/dev/null || true; fi; done",
  "echo 'Libraries in /usr/lib:'",
  "ls -la /usr/lib/libGL* /usr/lib/libglib* 2>/dev/null | head -10 || echo 'No libraries found'"
]
