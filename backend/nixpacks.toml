providers = ["python"]

[variables]
PYTHONUNBUFFERED = "1"

[phases.setup]
# Runtime dependencies for OpenCV
nixPkgs = ["python39", "libGL", "glib", "glibc", "libGLU", "pkg-config", "ffmpeg", "gcc"]
# Add library paths so OpenCV can find libraries at runtime
nixLibs = ["libGL", "glib", "libGLU"]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate && pip install --no-cache-dir --upgrade pip",
  ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
  # Clean up pip cache and unnecessary files
  "rm -rf /opt/venv/lib/python3.9/site-packages/*/tests",
  "rm -rf /opt/venv/lib/python3.9/site-packages/*/test",
  "find /opt/venv -type d -name '__pycache__' -exec rm -r {} + 2>/dev/null || true",
  "find /opt/venv -type f -name '*.pyc' -delete",
  "find /opt/venv -type f -name '*.pyo' -delete"
]

[phases.build]
cmds = [
  # Make scripts executable
  "chmod +x start.sh",
  "chmod +x create_libgl_stub.sh || true",
  # Create /usr/lib if it doesn't exist
  "mkdir -p /usr/lib",
  # Try to get libGL from Nix store first
  "GL_LIB=$(find /nix/store -name 'libGL.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$GL_LIB\" ]; then cp \"$GL_LIB\" /usr/lib/libGL.so.1 && echo \"Copied libGL.so.1 from Nix store\"; else echo \"libGL.so.1 not found in Nix store, will try stub\"; bash create_libgl_stub.sh || true; fi",
  # Copy other dependencies
  "GLIB_LIB=$(find /nix/store -name 'libglib-2.0.so.0' 2>/dev/null | head -n 1)",
  "if [ -n \"$GLIB_LIB\" ]; then cp \"$GLIB_LIB\" /usr/lib/libglib-2.0.so.0; fi",
  "GLU_LIB=$(find /nix/store -name 'libGLU.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$GLU_LIB\" ]; then cp \"$GLU_LIB\" /usr/lib/libGLU.so.1; fi",
  # Verify
  "ls -la /usr/lib/libGL.so.1 2>/dev/null && echo 'libGL.so.1 is present' || echo 'WARNING: libGL.so.1 missing!'"
]
