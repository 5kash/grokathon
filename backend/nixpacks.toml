providers = ["python"]

[variables]
PYTHONUNBUFFERED = "1"

[phases.setup]
# Runtime dependencies for OpenCV and NumPy
# Use gcc12 instead of gcc13 to avoid GLIBC version mismatch (gcc13 needs GLIBC 2.38, but we have 2.37)
nixPkgs = ["python39", "libGL", "glib", "glibc", "libGLU", "pkg-config", "ffmpeg", "gcc12", "zlib"]
# Add library paths so OpenCV can find libraries at runtime
nixLibs = ["libGL", "glib", "libGLU", "zlib"]

[phases.install]
cmds = [
  "python -m venv --copies /opt/venv",
  ". /opt/venv/bin/activate && pip install --no-cache-dir --upgrade pip",
  # CRITICAL: Install numpy 1.25.2 FIRST to prevent opencv from pulling numpy 2.0.2
  ". /opt/venv/bin/activate && pip install --no-cache-dir numpy==1.25.2",
  # CRITICAL: Install pandas 2.2.3 BEFORE ultralytics to prevent it from pulling pandas 2.3.3
  ". /opt/venv/bin/activate && pip install --no-cache-dir pandas==2.2.3",
  # Install opencv-python-headless (will use already-installed numpy 1.25.2)
  ". /opt/venv/bin/activate && pip install --no-cache-dir opencv-python-headless==4.8.1.78",
  ". /opt/venv/bin/activate && pip install --no-cache-dir -r requirements.txt",
  # Remove full opencv-python if it got installed (ultralytics might pull it in)
  ". /opt/venv/bin/activate && pip uninstall -y opencv-python 2>/dev/null || true",
  # Clean up pip cache and unnecessary files
  "rm -rf /opt/venv/lib/python3.9/site-packages/*/tests",
  "rm -rf /opt/venv/lib/python3.9/site-packages/*/test",
  "find /opt/venv -type d -name '__pycache__' -exec rm -r {} + 2>/dev/null || true",
  "find /opt/venv -type f -name '*.pyc' -delete",
  "find /opt/venv -type f -name '*.pyo' -delete",
  # Remove CUDA packages if they got installed (we only need CPU)
  ". /opt/venv/bin/activate && pip list | grep -i nvidia | awk '{print $1}' | xargs -r pip uninstall -y 2>/dev/null || true"
]

[phases.build]
cmds = [
  # Make scripts executable
  "chmod +x start.sh",
  "chmod +x create_libgl_stub.sh || true",
  # Create /usr/lib if it doesn't exist
  "mkdir -p /usr/lib",
  # Copy libGL and dependencies
  "GL_LIB=$(find /nix/store -name 'libGL.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$GL_LIB\" ]; then cp \"$GL_LIB\" /usr/lib/libGL.so.1 && echo \"Copied libGL.so.1\"; fi",
  "GLIB_LIB=$(find /nix/store -name 'libglib-2.0.so.0' 2>/dev/null | head -n 1)",
  "if [ -n \"$GLIB_LIB\" ]; then cp \"$GLIB_LIB\" /usr/lib/libglib-2.0.so.0 && echo \"Copied libglib-2.0.so.0\"; fi",
  "GLU_LIB=$(find /nix/store -name 'libGLU.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$GLU_LIB\" ]; then cp \"$GLU_LIB\" /usr/lib/libGLU.so.1 && echo \"Copied libGLU.so.1\"; fi",
  # Copy libstdc++ (C++ standard library)
  "STDCPP_LIB=$(find /nix/store -name 'libstdc++.so.6' 2>/dev/null | head -n 1)",
  "if [ -n \"$STDCPP_LIB\" ]; then cp \"$STDCPP_LIB\" /usr/lib/libstdc++.so.6 && echo \"Copied libstdc++.so.6\"; else echo \"WARNING: libstdc++.so.6 not found!\"; fi",
  # Also try libstdc++.so (without version)
  "STDCPP_LIB2=$(find /nix/store -name 'libstdc++.so' -not -name 'libstdc++.so.*' 2>/dev/null | head -n 1)",
  "if [ -n \"$STDCPP_LIB2\" ]; then cp \"$STDCPP_LIB2\" /usr/lib/libstdc++.so && echo \"Copied libstdc++.so\"; fi",
  # Copy libz (zlib - required by NumPy)
  "ZLIB_LIB=$(find /nix/store -name 'libz.so.1' 2>/dev/null | head -n 1)",
  "if [ -n \"$ZLIB_LIB\" ]; then cp \"$ZLIB_LIB\" /usr/lib/libz.so.1 && echo \"Copied libz.so.1\"; else echo \"WARNING: libz.so.1 not found!\"; fi",
  # Verify
  "echo 'Libraries in /usr/lib:'",
  "ls -la /usr/lib/libGL* /usr/lib/libglib* /usr/lib/libstdc++* /usr/lib/libz* 2>/dev/null | head -10 || echo 'Some libraries missing'"
]
